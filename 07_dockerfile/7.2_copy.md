## 7.2 COPY å¤åˆ¶æ–‡ä»¶

### åŸºæœ¬è¯­æ³•

å…·ä½“å†…å®¹å¦‚ä¸‹ï¼š

```docker
COPY [é€‰é¡¹] <æºè·¯å¾„>... <ç›®æ ‡è·¯å¾„>
COPY [é€‰é¡¹] ["<æºè·¯å¾„1>", "<æºè·¯å¾„2>", ... "<ç›®æ ‡è·¯å¾„>"]
```

`COPY` æŒ‡ä»¤å°†æ„å»ºä¸Šä¸‹æ–‡ä¸­çš„æ–‡ä»¶æˆ–ç›®å½•å¤åˆ¶åˆ°é•œåƒå†…ã€‚

---

### åŸºæœ¬ç”¨æ³•

#### å¤åˆ¶å•ä¸ªæ–‡ä»¶

å…·ä½“å†…å®¹å¦‚ä¸‹ï¼š

```docker
## å¤åˆ¶æ–‡ä»¶åˆ°æŒ‡å®šç›®å½•

COPY package.json /app/

## å¤åˆ¶æ–‡ä»¶å¹¶é‡å‘½å

COPY config.json /app/settings.json
```

#### å¤åˆ¶å¤šä¸ªæ–‡ä»¶

å…·ä½“å†…å®¹å¦‚ä¸‹ï¼š

```docker
## å¤åˆ¶å¤šä¸ªæŒ‡å®šæ–‡ä»¶

COPY package.json package-lock.json /app/

## ä½¿ç”¨é€šé…ç¬¦

COPY *.json /app/
COPY src/*.js /app/src/
```

#### å¤åˆ¶ç›®å½•

å…·ä½“å†…å®¹å¦‚ä¸‹ï¼š

```docker
## å¤åˆ¶æ•´ä¸ªç›®å½•çš„å†…å®¹ï¼ˆä¸æ˜¯ç›®å½•æœ¬èº«ï¼‰

COPY src/ /app/src/
```

> âš ï¸ **æ³¨æ„**ï¼šå¤åˆ¶ç›®å½•æ—¶ï¼Œå¤åˆ¶çš„æ˜¯ç›®å½•çš„**å†…å®¹**ï¼Œä¸åŒ…å«ç›®å½•æœ¬èº«ã€‚

```
æ„å»ºä¸Šä¸‹æ–‡ï¼š              é•œåƒå†…ï¼š
src/                     /app/src/
â”œâ”€â”€ index.js      â†’      â”œâ”€â”€ index.js
â””â”€â”€ utils.js             â””â”€â”€ utils.js
```

---

### é€šé…ç¬¦è§„åˆ™

COPY æ”¯æŒ Go çš„ `filepath.Match` é€šé…ç¬¦è§„åˆ™ï¼š

| é€šé…ç¬¦ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|
| `*` | åŒ¹é…ä»»æ„å­—ç¬¦åºåˆ— | `*.json` |
| `?` | åŒ¹é…å•ä¸ªå­—ç¬¦ | `config?.json` |
| `[abc]` | åŒ¹é…æ‹¬å·å†…ä»»ä¸€å­—ç¬¦ | `[abc].txt` |
| `[a-z]` | åŒ¹é…èŒƒå›´å†…å­—ç¬¦ | `file[0-9].txt` |

```docker
COPY hom* /mydir/       # home.txt, homework.md ç­‰
COPY hom?.txt /mydir/   # home.txt, homy.txt ç­‰
COPY app[0-9].js /app/  # app0.js ~ app9.js
```

---

### ç›®æ ‡è·¯å¾„

#### ç»å¯¹è·¯å¾„

å…·ä½“å†…å®¹å¦‚ä¸‹ï¼š

```docker
COPY app.js /usr/src/app/
```

#### ç›¸å¯¹è·¯å¾„ï¼ˆåŸºäº WORKDIRï¼‰

å…·ä½“å†…å®¹å¦‚ä¸‹ï¼š

```docker
WORKDIR /app
COPY package.json ./        # å¤åˆ¶åˆ° /app/package.json
COPY src/ ./src/            # å¤åˆ¶åˆ° /app/src/
```

#### è‡ªåŠ¨åˆ›å»ºç›®å½•

å¦‚æœç›®æ ‡ç›®å½•ä¸å­˜åœ¨ï¼ŒDocker ä¼šè‡ªåŠ¨åˆ›å»ºï¼š

```docker
## /app/config/ ä¸å­˜åœ¨ä¹Ÿä¼šè‡ªåŠ¨åˆ›å»º

COPY settings.json /app/config/
```

---

### ä¿®æ”¹æ–‡ä»¶æ‰€æœ‰è€…

ä½¿ç”¨ `--chown` é€‰é¡¹è®¾ç½®æ–‡ä»¶çš„ç”¨æˆ·å’Œç»„ï¼š

```docker
## ä½¿ç”¨ç”¨æˆ·åå’Œç»„å

COPY --chown=node:node package.json /app/

## ä½¿ç”¨ UID å’Œ GID

COPY --chown=1000:1000 . /app/

## åªæŒ‡å®šç”¨æˆ·

COPY --chown=node . /app/
```

> ğŸ’¡ ç»“åˆ `USER` æŒ‡ä»¤ä½¿ç”¨ï¼Œç¡®ä¿åº”ç”¨ä»¥é root ç”¨æˆ·è¿è¡Œã€‚

---

### ä¿ç•™æ–‡ä»¶å…ƒæ•°æ®

COPY ä¼šä¿ç•™æºæ–‡ä»¶çš„å…ƒæ•°æ®ï¼š
- è¯»ã€å†™ã€æ‰§è¡Œæƒé™
- ä¿®æ”¹æ—¶é—´

è¿™å¯¹äºè„šæœ¬æ–‡ä»¶ç‰¹åˆ«é‡è¦ï¼š

```docker
## start.sh çš„å¯æ‰§è¡Œæƒé™ä¼šè¢«ä¿ç•™

COPY start.sh /app/
```

---

### COPY vs ADD

| ç‰¹æ€§ | COPY | ADD |
|------|------|-----|
| å¤åˆ¶æœ¬åœ°æ–‡ä»¶ | âœ… | âœ… |
| è‡ªåŠ¨è§£å‹ tar | âŒ | âœ… |
| æ”¯æŒ URL | âŒ | âœ…ï¼ˆä¸æ¨èï¼‰ |
| æ¨èç¨‹åº¦ | âœ… **æ¨è** | âš ï¸ ç‰¹æ®Šåœºæ™¯ä½¿ç”¨ |

```docker
## æ¨èï¼šä½¿ç”¨ COPY

COPY app.tar.gz /app/
RUN tar -xzf /app/app.tar.gz

## ADD ä¼šè‡ªåŠ¨è§£å‹ï¼ˆè¡Œä¸ºä¸æ˜æ˜¾ï¼Œä¸æ¨èï¼‰

ADD app.tar.gz /app/
```

> ç¬”è€…å»ºè®®ï¼šé™¤ééœ€è¦è‡ªåŠ¨è§£å‹ tar æ–‡ä»¶ï¼Œå¦åˆ™å§‹ç»ˆä½¿ç”¨ COPYã€‚æ˜ç¡®çš„è¡Œä¸ºæ¯”éšå¼çš„é­”æ³•æ›´å¥½ã€‚

---

### å¤šé˜¶æ®µæ„å»ºä¸­çš„ COPY

#### ä»å…¶ä»–æ„å»ºé˜¶æ®µå¤åˆ¶

å…·ä½“å†…å®¹å¦‚ä¸‹ï¼š

```docker
## æ„å»ºé˜¶æ®µ

FROM node:20 AS builder
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

## ç”Ÿäº§é˜¶æ®µ

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
```

#### ä½¿ç”¨ --link ä¼˜åŒ–ç¼“å­˜ï¼ˆBuildKitï¼‰

å…·ä½“å†…å®¹å¦‚ä¸‹ï¼š

```docker
## ä½¿ç”¨ --link åï¼Œæ–‡ä»¶ä»¥ç‹¬ç«‹å±‚æ·»åŠ ï¼Œä¸ä¾èµ–å‰åºæŒ‡ä»¤

COPY --link --from=builder /app/dist /usr/share/nginx/html
```

`--link` çš„ä¼˜åŠ¿ï¼š
- æ›´é«˜æ•ˆåˆ©ç”¨æ„å»ºç¼“å­˜
- å¹¶è¡ŒåŒ–æ„å»ºè¿‡ç¨‹
- åŠ é€Ÿå¤šé˜¶æ®µæ„å»º

---

### .dockerignore

ä½¿ç”¨ `.dockerignore` æ’é™¤ä¸éœ€è¦å¤åˆ¶çš„æ–‡ä»¶ï¼š

```gitignore
## .dockerignore

node_modules
.git
.env
*.log
Dockerfile
.dockerignore
```

è¿™å¯ä»¥ï¼š
- å‡å°æ„å»ºä¸Šä¸‹æ–‡å¤§å°
- åŠ é€Ÿæ„å»º
- é¿å…å¤åˆ¶æ•æ„Ÿæ–‡ä»¶

---

### æœ€ä½³å®è·µ

#### 1. åˆ©ç”¨ç¼“å­˜ï¼Œå…ˆå¤åˆ¶ä¾èµ–æ–‡ä»¶

å…·ä½“å†…å®¹å¦‚ä¸‹ï¼š

```docker
## âœ… å¥½ï¼šå…ˆå¤åˆ¶ä¾èµ–å®šä¹‰ï¼Œå†å®‰è£…ï¼Œæœ€åå¤åˆ¶ä»£ç 

COPY package.json package-lock.json ./
RUN npm install
COPY . .

## âŒ å·®ï¼šä¸€æ¬¡æ€§å¤åˆ¶æ‰€æœ‰æ–‡ä»¶ï¼Œä»£ç å˜æ›´ä¼šå¯¼è‡´é‡æ–° npm install

COPY . .
RUN npm install
```

#### 2. ä½¿ç”¨ .dockerignore

å…·ä½“å†…å®¹å¦‚ä¸‹ï¼š

```docker
## ç¡®ä¿ node_modules ä¸è¢«å¤åˆ¶

COPY . .
## .dockerignore ä¸­åº”åŒ…å« node_modules

å…·ä½“å†…å®¹å¦‚ä¸‹ï¼š

```

#### 3. æ˜ç¡®å¤åˆ¶è·¯å¾„

å…·ä½“å†…å®¹å¦‚ä¸‹ï¼š

```docker
## âœ… å¥½ï¼šæ˜ç¡®çš„è·¯å¾„

COPY src/ /app/src/
COPY package.json /app/

## âŒ å·®ï¼šè¿‡äºå®½æ³›

COPY . .
```

---

### æœ¬ç« å°ç»“

| æ“ä½œ | ç¤ºä¾‹ |
|------|------|
| å¤åˆ¶æ–‡ä»¶ | `COPY app.js /app/` |
| å¤åˆ¶å¤šä¸ªæ–‡ä»¶ | `COPY *.json /app/` |
| å¤åˆ¶ç›®å½•å†…å®¹ | `COPY src/ /app/src/` |
| ä¿®æ”¹æ‰€æœ‰è€… | `COPY --chown=node:node . /app/` |
| ä»æ„å»ºé˜¶æ®µå¤åˆ¶ | `COPY --from=builder /app/dist ./` |

### å»¶ä¼¸é˜…è¯»

- [ADD æŒ‡ä»¤](add.md)ï¼šå¤åˆ¶å’Œè§£å‹
- [WORKDIR æŒ‡ä»¤](workdir.md)ï¼šè®¾ç½®å·¥ä½œç›®å½•
- [å¤šé˜¶æ®µæ„å»º](../multistage-builds.md)ï¼šä¼˜åŒ–é•œåƒå¤§å°
- [æœ€ä½³å®è·µ](../../16_appendix/16.1_best_practices.md)ï¼šDockerfile ç¼–å†™æŒ‡å—
