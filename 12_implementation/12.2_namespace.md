## 12.2 å‘½åç©ºé—´

å‘½åç©ºé—´æ˜¯ Linux å†…æ ¸ä¸€ä¸ªå¼ºå¤§çš„ç‰¹æ€§ã€‚æ¯ä¸ªå®¹å™¨éƒ½æœ‰è‡ªå·±å•ç‹¬çš„å‘½åç©ºé—´ï¼Œè¿è¡Œåœ¨å…¶ä¸­çš„åº”ç”¨éƒ½åƒæ˜¯åœ¨ç‹¬ç«‹çš„æ“ä½œç³»ç»Ÿä¸­è¿è¡Œä¸€æ ·ã€‚å‘½åç©ºé—´ä¿è¯äº†å®¹å™¨ä¹‹é—´å½¼æ­¤äº’ä¸å½±å“ã€‚

## 12.2 ä»€ä¹ˆæ˜¯ Namespace

> **Namespace æ˜¯ Linux å†…æ ¸æä¾›çš„èµ„æºéš”ç¦»æœºåˆ¶ï¼Œå®ƒè®©å®¹å™¨å†…çš„è¿›ç¨‹ä»¿ä½›è¿è¡Œåœ¨ç‹¬ç«‹çš„æ“ä½œç³»ç»Ÿä¸­ã€‚** Namespace æ˜¯å®¹å™¨æŠ€æœ¯çš„æ ¸å¿ƒåŸºç¡€ä¹‹ä¸€ã€‚å®ƒå›ç­”äº†ä¸€ä¸ªå…³é”®é—®é¢˜ï¼š**å¦‚ä½•è®©ä¸€ä¸ªè¿›ç¨‹ â€œä»¥ä¸ºâ€ è‡ªå·±ç‹¬å æ•´ä¸ªç³»ç»Ÿï¼Ÿ**

```mermaid
flowchart LR
    subgraph Host ["å®¿ä¸»æœºè§†è§’"]
        direction TB
        H1["PID 1: systemd"]
        H2["PID 2: sshd"]
        H3["PID 3: dockerd"]
        H4["PID 1234: nginx"]
        H5["PID 1235: nginx worker"]
    end
    
    subgraph Container ["å®¹å™¨å†…è§†è§’"]
        direction TB
        C1["PID 1: nginx<br/>â† å®¹å™¨è®¤ä¸ºè‡ªå·±æ˜¯ PID 1"]
        C2["PID 2: nginx worker"]
    end
    
    H4 -. "ï¼ˆå®é™…æ˜¯å®¿ä¸»æœºçš„ 1234ï¼‰" .- C1
```

### 12.2.1 Namespace çš„ç±»å‹

Linux å†…æ ¸æä¾›äº†ä»¥ä¸‹å‡ ç§ Namespaceï¼ŒDocker å®¹å™¨ä½¿ç”¨äº†å…¨éƒ¨ï¼š

| Namespace | éš”ç¦»å†…å®¹ | å®¹å™¨ä¸­çš„æ•ˆæœ |
|-----------|---------|-------------|
| **PID** | è¿›ç¨‹ ID | å®¹å™¨å†… PID ä» 1 å¼€å§‹ï¼Œçœ‹ä¸åˆ°å…¶ä»–å®¹å™¨å’Œå®¿ä¸»æœºè¿›ç¨‹ |
| **NET** | ç½‘ç»œæ ˆ | ç‹¬ç«‹çš„ç½‘å¡ã€IP åœ°å€ã€ç«¯å£ã€è·¯ç”±è¡¨ |
| **MNT** | æŒ‚è½½ç‚¹ | ç‹¬ç«‹çš„æ–‡ä»¶ç³»ç»Ÿè§†å›¾ï¼Œè‡ªå·±çš„æ ¹ç›®å½• |
| **UTS** | ä¸»æœºå | ç‹¬ç«‹çš„ä¸»æœºåå’ŒåŸŸå |
| **IPC** | è¿›ç¨‹é—´é€šä¿¡ | ç‹¬ç«‹çš„ä¿¡å·é‡ã€æ¶ˆæ¯é˜Ÿåˆ—ã€å…±äº«å†…å­˜ |
| **USER** | ç”¨æˆ·/ç»„ ID | å®¹å™¨å†…çš„ root å¯ä»¥æ˜ å°„ä¸ºå®¿ä¸»æœºçš„æ™®é€šç”¨æˆ· |
| **Cgroup** | Cgroup æ ¹ç›®å½• | éš”ç¦» cgroup å±‚çº§è§†å›¾ (Linux 4.6+)|

---

### 12.2.2 PID Namespace

PID Namespace è´Ÿè´£è¿›ç¨‹ ID çš„éš”ç¦»ï¼Œä½¿å¾—å®¹å™¨å†…çš„è¿›ç¨‹å½¼æ­¤ä¸å¯è§ã€‚

#### PID çš„ä½œç”¨

éš”ç¦»è¿›ç¨‹ IDï¼Œè®©æ¯ä¸ªå®¹å™¨æœ‰è‡ªå·±çš„è¿›ç¨‹ç¼–å·ç©ºé—´ã€‚

#### PID éš”ç¦»æ•ˆæœ

```bash
## å®¿ä¸»æœºä¸ŠæŸ¥çœ‹è¿›ç¨‹

$ ps aux | grep nginx
root     12345  0.0  0.1  nginx: master process
root     12346  0.0  0.1  nginx: worker process

## å®¹å™¨å†…æŸ¥çœ‹è¿›ç¨‹

$ docker exec mycontainer ps aux
PID   USER     COMMAND
  1   root     nginx: master process    â† åœ¨å®¹å™¨å†…æ˜¯ PID 1
  2   root     nginx: worker process
```

#### PID å…³é”®ç‚¹

- å®¹å™¨å†…çš„ PID 1 è¿›ç¨‹ç‰¹æ®Šé‡è¦â€”â€”å®ƒæ˜¯å®¹å™¨çš„ä¸»è¿›ç¨‹ï¼Œé€€å‡ºåˆ™å®¹å™¨åœæ­¢
- å®¹å™¨å†…æ— æ³•çœ‹åˆ°å®¿ä¸»æœºæˆ–å…¶ä»–å®¹å™¨çš„è¿›ç¨‹
- å®¿ä¸»æœºå¯ä»¥çœ‹åˆ°æ‰€æœ‰å®¹å™¨å†…çš„è¿›ç¨‹ (ä½† PID ä¸åŒ)

---

### 12.2.3 NET Namespace

NET Namespace è´Ÿè´£ç½‘ç»œæ ˆçš„éš”ç¦»ï¼ŒåŒ…æ‹¬ç½‘å¡ã€è·¯ç”±è¡¨å’Œ iptables è§„åˆ™ç­‰ã€‚

#### NET çš„ä½œç”¨

éš”ç¦»ç½‘ç»œæ ˆï¼Œæ¯ä¸ªå®¹å™¨æ‹¥æœ‰ç‹¬ç«‹çš„ç½‘ç»œç¯å¢ƒã€‚

#### NET éš”ç¦»æ•ˆæœ

```mermaid
flowchart LR
    subgraph Host ["å®¿ä¸»æœº"]
        direction TB
        H1["eth0: 192.168.1.10<br/>ç«¯å£ 80 å¯ç”¨"]
        H2["docker0: 172.17.0.1"]
    end
    
    subgraph Container ["å®¹å™¨"]
        direction TB
        C1["eth0: 172.17.0.2<br/>ç«¯å£ 80 å¯ç”¨"]
        C2["(veth pair è¿æ¥)"]
    end
    
    H2 <--> C2
```

#### NET å…³é”®ç‚¹

- æ¯ä¸ªå®¹å™¨æœ‰ç‹¬ç«‹çš„ç½‘å¡ã€IPã€è·¯ç”±è¡¨ã€iptables è§„åˆ™
- å¤šä¸ªå®¹å™¨å¯ä»¥ç›‘å¬ç›¸åŒç«¯å£ (å¦‚éƒ½ç›‘å¬ 80)
- Docker ä½¿ç”¨ veth pair è¿æ¥å®¹å™¨ç½‘ç»œå’Œå®¿ä¸»æœºç½‘æ¡¥

---

### 12.2.4 MNT Namespace

MNT Namespace è´Ÿè´£æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ç‚¹çš„éš”ç¦»ï¼Œç¡®ä¿å®¹å™¨çœ‹åˆ°ç‹¬ç«‹çš„æ–‡ä»¶ç³»ç»Ÿè§†å›¾ã€‚

#### MNT çš„ä½œç”¨

éš”ç¦»æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ç‚¹ï¼Œæ¯ä¸ªå®¹å™¨æœ‰è‡ªå·±çš„æ ¹ç›®å½•ã€‚

#### MNT éš”ç¦»æ•ˆæœ

```bash
å®¿ä¸»æœºæ–‡ä»¶ç³»ç»Ÿï¼š                  å®¹å™¨å†…çœ‹åˆ°çš„ï¼š
/                               /  â† å®¹å™¨çš„æ ¹ç›®å½•
â”œâ”€â”€ bin/                        â”œâ”€â”€ bin/
â”œâ”€â”€ home/                       â”œâ”€â”€ home/
â”œâ”€â”€ var/                        â”œâ”€â”€ var/
â”‚   â””â”€â”€ lib/                    â”‚   â””â”€â”€ lib/
â”‚       â””â”€â”€ docker/             â”‚
â”‚           â””â”€â”€ overlay2/       â”‚
â”‚               â””â”€â”€ merged/ â”€â”€â”€â”€â”¼â”€â”€â”€ è¿™ä¸ªç›®å½•æˆä¸ºå®¹å™¨çš„ /
â””â”€â”€ ...                         â””â”€â”€ ...
```

#### ä¸ chroot çš„åŒºåˆ«

| ç‰¹æ€§ | chroot | MNT Namespace |
|------|--------|---------------|
| å®‰å…¨æ€§ | å¯ä»¥é€ƒé€¸ | æ›´å®‰å…¨ |
| æŒ‚è½½éš”ç¦» | æ—  | å®Œå…¨éš”ç¦» |
| /proc/mounts | å…±äº« | ç‹¬ç«‹ |

---

### 12.2.5 UTS Namespace

UTS Namespace ä¸»è¦ç”¨äºéš”ç¦»ä¸»æœºåå’ŒåŸŸåã€‚

#### UTS çš„ä½œç”¨

éš”ç¦»ä¸»æœºåå’ŒåŸŸåï¼Œè®©æ¯ä¸ªå®¹å™¨å¯ä»¥æœ‰è‡ªå·±çš„ä¸»æœºåã€‚

#### UTS éš”ç¦»æ•ˆæœ

```bash
## å®¿ä¸»æœº

$ hostname
my-server

## å®¹å™¨å†…

$ docker run --hostname mycontainer ubuntu hostname
mycontainer
```

UTS = â€œUNIX Time-sharing Systemâ€ï¼Œæ˜¯å†å²é—ç•™çš„åç§°ã€‚

---

### 12.2.6 IPC Namespace

IPC Namespace ç”¨äºéš”ç¦»è¿›ç¨‹é—´é€šä¿¡èµ„æºï¼Œå¦‚ System V IPC å’Œ POSIX æ¶ˆæ¯é˜Ÿåˆ—ã€‚

#### IPC çš„ä½œç”¨

éš”ç¦» System V IPC å’Œ POSIX æ¶ˆæ¯é˜Ÿåˆ—ã€‚

#### éš”ç¦»çš„èµ„æº

- ä¿¡å·é‡ (semaphores)
- æ¶ˆæ¯é˜Ÿåˆ— (message queues)
- å…±äº«å†…å­˜ (shared memory)

#### IPC å…³é”®ç‚¹

- åŒä¸€å®¹å™¨å†…çš„è¿›ç¨‹å¯ä»¥é€šè¿‡ IPC é€šä¿¡
- ä¸åŒå®¹å™¨çš„è¿›ç¨‹æ— æ³•é€šè¿‡ IPC é€šä¿¡ (é™¤éæ˜¾å¼å…±äº«)

---

### 12.2.7 USER Namespace

USER Namespace å…è®¸å°†å®¹å™¨å†…çš„ç”¨æˆ· ID æ˜ å°„åˆ°å®¿ä¸»æœºçš„ä¸åŒç”¨æˆ· IDã€‚

#### USER çš„ä½œç”¨

éš”ç¦»ç”¨æˆ·å’Œç»„ IDï¼Œå®ç°æƒé™éš”ç¦»ã€‚

#### USER éš”ç¦»æ•ˆæœ

```mermaid
flowchart LR
    subgraph Container ["å®¹å™¨å†…"]
        direction TB
        C1["UID 0 (root)"]
        C2["UID 1 (daemon)"]
    end

    subgraph Host ["å®¿ä¸»æœº"]
        direction TB
        H1["UID 100000<br/>â† éç‰¹æƒç”¨æˆ·"]
        H2["UID 100001"]
    end

    C1 -- æ˜ å°„ --> H1
    C2 -- æ˜ å°„ --> H2
```

#### å®‰å…¨æ„ä¹‰

å®¹å™¨å†…çš„ root ç”¨æˆ·å¯ä»¥æ˜ å°„ä¸ºå®¿ä¸»æœºä¸Šçš„æ™®é€šç”¨æˆ·ï¼Œå³ä½¿å®¹å™¨è¢«çªç ´ï¼Œæ”»å‡»è€…åœ¨å®¿ä¸»æœºä¸Šä¹Ÿåªæœ‰æ™®é€šæƒé™ã€‚

> ğŸ’¡ ç¬”è€…å»ºè®®ï¼šç”Ÿäº§ç¯å¢ƒå»ºè®®å¯ç”¨ User Namespaceï¼Œå¢å¼ºå®‰å…¨æ€§ã€‚

---

### 12.2.8 åŠ¨æ‰‹å®éªŒï¼šä½“éªŒ Namespace

ä½¿ç”¨ `unshare` å‘½ä»¤å¯ä»¥åœ¨ä¸ä½¿ç”¨ Docker çš„æƒ…å†µä¸‹ä½“éªŒ Namespaceï¼š

#### å®éªŒ 1ï¼šUTS Namespace

```bash
## åˆ›å»ºæ–°çš„ UTS namespace å¹¶å¯åŠ¨ shell

$ sudo unshare --uts /bin/bash

## ä¿®æ”¹ä¸»æœºåï¼ˆåªå½±å“è¿™ä¸ª namespaceï¼‰

$ hostname container-test
$ hostname
container-test

## é€€å‡ºåæŸ¥çœ‹å®¿ä¸»æœºä¸»æœºåï¼ˆæœªæ”¹å˜ï¼‰

$ exit
$ hostname
my-server
```

#### å®éªŒ 2ï¼šPID Namespace

```bash
## åˆ›å»ºæ–°çš„ PID å’Œ MNT namespace

$ sudo unshare --pid --mount --fork /bin/bash

## æŒ‚è½½æ–°çš„ /proc

$ mount -t proc proc /proc

## æŸ¥çœ‹è¿›ç¨‹ï¼ˆåªèƒ½çœ‹åˆ°å½“å‰ shellï¼‰

$ ps aux
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root         1  0.0  0.0   8960  4516 pts/0    S    10:00   0:00 /bin/bash
root         8  0.0  0.0  10072  3200 pts/0    R+   10:00   0:00 ps aux
```

#### å®éªŒ 3ï¼šNET Namespace

```bash
## åˆ›å»ºæ–°çš„ç½‘ç»œ namespace

$ sudo unshare --net /bin/bash

## æŸ¥çœ‹ç½‘ç»œæ¥å£ï¼ˆåªæœ‰ loï¼‰

$ ip addr
1: lo: <LOOPBACK> mtu 65536 qdisc noop state DOWN
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
```

---

### 12.2.9 Namespace çš„å±€é™æ€§

Namespace æä¾›äº†éš”ç¦»ä½†ä¸æ˜¯å®‰å…¨è¾¹ç•Œï¼š

| æ–¹é¢ | è¯´æ˜ |
|------|------|
| **å…±äº«å†…æ ¸** | æ‰€æœ‰å®¹å™¨å…±äº«å®¿ä¸»æœºå†…æ ¸ï¼Œå†…æ ¸æ¼æ´å¯èƒ½å½±å“æ‰€æœ‰å®¹å™¨ |
| **éƒ¨åˆ†èµ„æºæœªéš”ç¦»** | /procã€/sys éƒ¨åˆ†å†…å®¹ä»å¯è§ï¼›æ—¶é—´æ— æ³•éš”ç¦» |
| **éè™šæ‹ŸåŒ–** | æ¯”è™šæ‹Ÿæœºéš”ç¦»æ€§å¼± |

> éœ€è¦æ›´å¼ºéš”ç¦»æ—¶ï¼Œå¯è€ƒè™‘ gVisorã€Kata Containers ç­‰å®‰å…¨å®¹å™¨æ–¹æ¡ˆã€‚

---
