## 10.7 ä½¿ç”¨ Rails

> æœ¬å°èŠ‚å†…å®¹é€‚åˆ Ruby å¼€å‘äººå‘˜é˜…è¯»ã€‚

æœ¬èŠ‚ä½¿ç”¨ Docker Compose é…ç½®å¹¶è¿è¡Œä¸€ä¸ª **Rails + PostgreSQL** åº”ç”¨ã€‚

### æ¶æ„æ¦‚è§ˆ

å¦‚å›¾ 10-2 æ‰€ç¤ºï¼ŒRails ä¸ PostgreSQL åœ¨åŒä¸€ Compose ç½‘ç»œä¸­ååŒå·¥ä½œã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Docker Compose ç½‘ç»œ                     â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚     web æœåŠ¡         â”‚      â”‚      db æœåŠ¡        â”‚       â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚       â”‚
â”‚  â”‚  â”‚   Rails       â”‚  â”‚â”€â”€â”€â”€â”€â”€â”‚  â”‚  PostgreSQL   â”‚  â”‚       â”‚
â”‚  â”‚  â”‚   åº”ç”¨        â”‚  â”‚ :5432â”‚  â”‚   æ•°æ®åº“      â”‚  â”‚       â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚       â”‚
â”‚  â”‚       :3000         â”‚      â”‚                     â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚             â”‚                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
         localhost:3000
```

å›¾ 10-2 Rails + PostgreSQL çš„ Compose æ¶æ„

### å‡†å¤‡å·¥ä½œ

åˆ›å»ºé¡¹ç›®ç›®å½•ï¼š

```bash
$ mkdir rails-docker && cd rails-docker
```

éœ€è¦åˆ›å»ºä¸‰ä¸ªæ–‡ä»¶ï¼š`Dockerfile`ã€`Gemfile` å’Œ `compose.yaml`ã€‚

### æ­¥éª¤ 1ï¼šåˆ›å»º Dockerfile

```docker
FROM ruby:3.2

## å®‰è£…ç³»ç»Ÿä¾èµ–

RUN apt-get update -qq && \
    apt-get install -y build-essential libpq-dev nodejs && \
    rm -rf /var/lib/apt/lists/*

## è®¾ç½®å·¥ä½œç›®å½•

WORKDIR /myapp

## å…ˆå¤åˆ¶ Gemfileï¼Œåˆ©ç”¨ç¼“å­˜åŠ é€Ÿæ„å»º

COPY Gemfile /myapp/Gemfile
COPY Gemfile.lock /myapp/Gemfile.lock
RUN bundle install

## å¤åˆ¶åº”ç”¨ä»£ç 

COPY . /myapp
```

**é…ç½®è¯´æ˜**ï¼š

| æŒ‡ä»¤ | ä½œç”¨ |
|------|------|
| `build-essential` | ç¼–è¯‘åŸç”Ÿæ‰©å±•æ‰€éœ€ |
| `libpq-dev` | PostgreSQL å®¢æˆ·ç«¯åº“ |
| `nodejs` | Rails Asset Pipeline éœ€è¦ |
| å…ˆå¤åˆ¶ Gemfile | åªæœ‰ä¾èµ–å˜åŒ–æ—¶æ‰é‡æ–° `bundle install` |

### æ­¥éª¤ 2ï¼šåˆ›å»º Gemfile

åˆ›å»ºä¸€ä¸ªåˆå§‹çš„ `Gemfile`ï¼Œç¨åä¼šè¢« `rails new` è¦†ç›–ï¼š

```ruby
source 'https://rubygems.org'
gem 'rails', '~> 7.1'
```

åˆ›å»ºç©ºçš„ `Gemfile.lock`ï¼š

```bash
$ touch Gemfile.lock
```

### æ­¥éª¤ 3ï¼šåˆ›å»º compose.yaml

é…ç½®å¦‚ä¸‹ï¼š

```yaml
services:
  db:
    image: postgres:16
    environment:
      POSTGRES_PASSWORD: password
    volumes:
      - postgres_data:/var/lib/postgresql/data

  web:
    build: .
    command: bash -c "rm -f tmp/pids/server.pid && bundle exec rails s -p 3000 -b '0.0.0.0'"
    volumes:
      - .:/myapp
    ports:
      - "3000:3000"
    depends_on:
      - db
    environment:
      DATABASE_URL: postgres://postgres:password@db:5432/myapp_development

volumes:
  postgres_data:
```

**é…ç½®è¯¦è§£**ï¼š

| é…ç½®é¡¹ | è¯´æ˜ |
|--------|------|
| `rm -f tmp/pids/server.pid` | æ¸…ç†ä¸Šæ¬¡å¼‚å¸¸é€€å‡ºç•™ä¸‹çš„ PID æ–‡ä»¶ |
| `volumes: .:/myapp` | æŒ‚è½½ä»£ç ç›®å½•ï¼Œæ”¯æŒçƒ­æ›´æ–° |
| `depends_on: db` | ç¡®ä¿æ•°æ®åº“å…ˆå¯åŠ¨ |
| `DATABASE_URL` | Rails 12-factor é£æ ¼çš„æ•°æ®åº“é…ç½® |

### æ­¥éª¤ 4ï¼šç”Ÿæˆ Rails é¡¹ç›®

ä½¿ç”¨ `docker compose run` ç”Ÿæˆé¡¹ç›®éª¨æ¶ï¼š

```bash
$ docker compose run --rm web rails new . --force --database=postgresql --skip-bundle
```

**å‘½ä»¤è§£é‡Š**ï¼š
- `--rm`ï¼šæ‰§è¡Œååˆ é™¤ä¸´æ—¶å®¹å™¨
- `--force`ï¼šè¦†ç›–å·²å­˜åœ¨çš„æ–‡ä»¶
- `--database=postgresql`ï¼šé…ç½®ä½¿ç”¨ PostgreSQL
- `--skip-bundle`ï¼šæš‚ä¸å®‰è£…ä¾èµ–ï¼ˆç¨åç»Ÿä¸€å®‰è£…ï¼‰

ç”Ÿæˆçš„ç›®å½•ç»“æ„ï¼š

```bash
$ ls
Dockerfile       Gemfile          Rakefile         config           lib              tmp
Gemfile.lock     README.md        app              config.ru        log              vendor
compose.yaml     bin              db               public

```

> âš ï¸ **Linux ç”¨æˆ·**ï¼šå¦‚é‡æƒé™é—®é¢˜ï¼Œæ‰§è¡Œ `sudo chown -R $USER:$USER .`

### æ­¥éª¤ 5ï¼šé‡æ–°æ„å»ºé•œåƒ

ç”±äºç”Ÿæˆäº†æ–°çš„ Gemfileï¼Œéœ€è¦é‡æ–°æ„å»ºé•œåƒä»¥å®‰è£…å®Œæ•´ä¾èµ–ï¼š

```bash
$ docker compose build
```

### æ­¥éª¤ 6ï¼šé…ç½®æ•°æ®åº“è¿æ¥

ä¿®æ”¹ `config/database.yml`ï¼š

```yaml
default: &default
  adapter: postgresql
  encoding: unicode
  pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %>
  url: <%= ENV['DATABASE_URL'] %>

development:
  <<: *default

test:
  <<: *default
  database: myapp_test

production:
  <<: *default
```

> ğŸ’¡ ä½¿ç”¨ `DATABASE_URL` ç¯å¢ƒå˜é‡é…ç½®æ•°æ®åº“ï¼Œç¬¦åˆ 12-factor åº”ç”¨åŸåˆ™ï¼Œä¾¿äºåœ¨ä¸åŒç¯å¢ƒé—´åˆ‡æ¢ã€‚

### æ­¥éª¤ 7ï¼šå¯åŠ¨åº”ç”¨

è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
$ docker compose up
```

è¾“å‡ºç¤ºä¾‹ï¼š

```
db-1   | PostgreSQL init process complete; ready for start up.
db-1   | LOG:  database system is ready to accept connections
web-1  | => Booting Puma
web-1  | => Rails 7.1.0 application starting in development
web-1  | => Run `bin/rails server --help` for more startup options
web-1  | Puma starting in single mode...
web-1  | * Listening on http://0.0.0.0:3000
```

### æ­¥éª¤ 8ï¼šåˆ›å»ºæ•°æ®åº“

åœ¨å¦ä¸€ä¸ªç»ˆç«¯æ‰§è¡Œï¼š

```bash
$ docker compose exec web rails db:create
Created database 'myapp_development'
Created database 'myapp_test'
```

è®¿é—® http://localhost:3000 æŸ¥çœ‹ Rails æ¬¢è¿é¡µé¢ã€‚

### å¸¸ç”¨å¼€å‘å‘½ä»¤

è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
## æ•°æ®åº“è¿ç§»

$ docker compose exec web rails db:migrate

## Rails æ§åˆ¶å°

$ docker compose exec web rails console

## è¿è¡Œæµ‹è¯•

$ docker compose exec web rails test

## ç”Ÿæˆè„šæ‰‹æ¶

$ docker compose exec web rails generate scaffold Post title:string body:text

## è¿›å…¥å®¹å™¨ Shell

$ docker compose exec web bash
```

### å¸¸è§é—®é¢˜

#### Q: æ•°æ®åº“è¿æ¥å¤±è´¥

æ£€æŸ¥ `DATABASE_URL` ç¯å¢ƒå˜é‡æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼Œç¡®ä¿ db æœåŠ¡å·²å¯åŠ¨ï¼š

```bash
$ docker compose ps
$ docker compose logs db
```

#### Q: server.pid æ–‡ä»¶å¯¼è‡´å¯åŠ¨å¤±è´¥

é”™è¯¯ä¿¡æ¯ï¼š`A server is already running`

å·²åœ¨ command ä¸­æ·»åŠ  `rm -f tmp/pids/server.pid` å¤„ç†ã€‚å¦‚ä»æœ‰é—®é¢˜ï¼š

```bash
$ docker compose exec web rm -f tmp/pids/server.pid
```

#### Q: Gem å®‰è£…å¤±è´¥

å¯èƒ½éœ€è¦æ›´æ–° bundler æˆ–æ¸…ç†ç¼“å­˜ï¼š

```bash
$ docker compose run --rm web bundle update
```

### å¼€å‘ vs ç”Ÿäº§

| é…ç½®é¡¹ | å¼€å‘ç¯å¢ƒ | ç”Ÿäº§ç¯å¢ƒ |
|--------|---------|---------|
| Rails æœåŠ¡å™¨ | Puma (å¼€å‘æ¨¡å¼) | Puma + Nginx |
| ä»£ç æŒ‚è½½ | ä½¿ç”¨ volumes | ä»£ç æ‰“åŒ…è¿›é•œåƒ |
| é™æ€èµ„æº | åŠ¨æ€ç¼–è¯‘ | é¢„ç¼–è¯‘ (`rails assets:precompile`) |
| æ•°æ®åº“å¯†ç  | æ˜æ–‡é…ç½® | ä½¿ç”¨ Secrets ç®¡ç† |

### å»¶ä¼¸é˜…è¯»

- [ä½¿ç”¨ Django](10.6_django.md)ï¼šPython Web æ¡†æ¶å®æˆ˜
- [Compose æ¨¡æ¿æ–‡ä»¶](10.5_compose_file.md)ï¼šé…ç½®è¯¦è§£
- [æ•°æ®ç®¡ç†](../08_data_network/README.md)ï¼šæ•°æ®æŒä¹…åŒ–
