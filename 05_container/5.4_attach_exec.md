## 5.4 è¿›å…¥å®¹å™¨

æœ¬èŠ‚æ¶µç›–äº†ç›¸å…³å†…å®¹ä¸è¯¦ç»†æè¿°ï¼Œä¸»è¦æ¢è®¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

### 5.4.1 ä¸ºä»€ä¹ˆéœ€è¦è¿›å…¥å®¹å™¨

ä½¿ç”¨ `-d` å‚æ•°å¯åŠ¨å®¹å™¨åï¼Œå®¹å™¨åœ¨åå°è¿è¡Œã€‚ä»¥ä¸‹åœºæ™¯éœ€è¦è¿›å…¥å®¹å™¨å†…éƒ¨æ“ä½œï¼š

| åœºæ™¯ | ç¤ºä¾‹ |
|------|------|
| **è°ƒè¯•é—®é¢˜** | æŸ¥çœ‹æ—¥å¿—ã€æ£€æŸ¥é…ç½®ã€æ’æŸ¥é”™è¯¯ |
| **ä¸´æ—¶æ“ä½œ** | æ‰§è¡Œæ•°æ®åº“è¿ç§»ã€æ¸…ç†ç¼“å­˜ |
| **æ£€æŸ¥çŠ¶æ€** | æŸ¥çœ‹è¿›ç¨‹ã€ç½‘ç»œè¿æ¥ã€æ–‡ä»¶ç³»ç»Ÿ |
| **å¼€å‘æµ‹è¯•** | äº¤äº’å¼æµ‹è¯•å‘½ä»¤ã€éªŒè¯ç¯å¢ƒ |

### 5.4.2 ä¸¤ç§è¿›å…¥æ–¹å¼

Docker æä¾›ä¸¤ç§è¿›å…¥å®¹å™¨çš„å‘½ä»¤ï¼š

| å‘½ä»¤ | æ¨èç¨‹åº¦ | ç‰¹ç‚¹ |
|------|---------|------|
| `docker exec` | âœ… **æ¨è** | å¯åŠ¨æ–°è¿›ç¨‹ï¼Œé€€å‡ºä¸å½±å“å®¹å™¨ |
| `docker attach` | âš ï¸ è°¨æ…ä½¿ç”¨ | é™„åŠ åˆ°ä¸»è¿›ç¨‹ï¼Œé€€å‡ºå¯èƒ½åœæ­¢å®¹å™¨ |

---

### 5.4.3 docker exec (æ¨è)

æœ¬èŠ‚æ¶µç›–äº†ç›¸å…³å†…å®¹ä¸è¯¦ç»†æè¿°ï¼Œä¸»è¦æ¢è®¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

#### docker exec åŸºæœ¬ç”¨æ³•

è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
## è¿›å…¥å®¹å™¨å¹¶å¯åŠ¨äº¤äº’å¼ shell

$ docker exec -it å®¹å™¨å /bin/bash

## æˆ–ä½¿ç”¨ shï¼ˆé€‚ç”¨äº Alpine ç­‰ç²¾ç®€é•œåƒï¼‰

$ docker exec -it å®¹å™¨å /bin/sh
```

#### å‚æ•°è¯´æ˜

ç›¸å…³ä¿¡æ¯å¦‚ä¸‹è¡¨ï¼š

| å‚æ•° | ä½œç”¨ |
|------|------|
| `-i` | ä¿æŒæ ‡å‡†è¾“å…¥æ‰“å¼€ (interactive)|
| `-t` | åˆ†é…ä¼ªç»ˆç«¯ (TTY)|
| `-it` | ä¸¤è€…ç»„åˆï¼Œè·å¾—å®Œæ•´äº¤äº’ä½“éªŒ |
| `-u` | æŒ‡å®šç”¨æˆ· (å¦‚ `-u root`)|
| `-w` | æŒ‡å®šå·¥ä½œç›®å½• |
| `-e` | è®¾ç½®ç¯å¢ƒå˜é‡ |

#### docker exec ç¤ºä¾‹

è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
## å¯åŠ¨ä¸€ä¸ªåå°å®¹å™¨

$ docker run -dit --name myubuntu ubuntu
69d137adef7a...

## è¿›å…¥å®¹å™¨ï¼ˆäº¤äº’å¼ shellï¼‰

$ docker exec -it myubuntu bash
root@69d137adef7a:/# ls
bin  boot  dev  etc  home  lib  ...
root@69d137adef7a:/# exit

## å®¹å™¨ä»åœ¨è¿è¡Œï¼

$ docker ps
CONTAINER ID   IMAGE    STATUS         NAMES
69d137adef7a   ubuntu   Up 2 minutes   myubuntu
```

#### æ‰§è¡Œå•æ¡å‘½ä»¤

ä¸è¿›å…¥äº¤äº’æ¨¡å¼ï¼Œç›´æ¥æ‰§è¡Œå‘½ä»¤ï¼š

```bash
## æŸ¥çœ‹å®¹å™¨å†…è¿›ç¨‹

$ docker exec myubuntu ps aux

## æŸ¥çœ‹é…ç½®æ–‡ä»¶

$ docker exec myubuntu cat /etc/nginx/nginx.conf

## ä»¥ root ç”¨æˆ·æ‰§è¡Œ

$ docker exec -u root myubuntu apt update
```

#### åªç”¨ -i ä¸ç”¨ -t çš„åŒºåˆ«

è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
## åªç”¨ -iï¼šå¯ä»¥æ‰§è¡Œå‘½ä»¤ï¼Œä½†æ²¡æœ‰æç¤ºç¬¦

$ docker exec -i myubuntu bash
ls           # è¾“å…¥å‘½ä»¤
bin          # è¾“å‡ºç»“æœ
boot
dev
...

## ç”¨ -itï¼šæœ‰å®Œæ•´çš„ç»ˆç«¯ä½“éªŒ

$ docker exec -it myubuntu bash
root@69d137adef7a:/#    # æœ‰æç¤ºç¬¦
```

> ğŸ’¡ é€šå¸¸ä½¿ç”¨ `-it` ç»„åˆã€‚åªæœ‰åœ¨è„šæœ¬ä¸­éœ€è¦é€šè¿‡ç®¡é“ä¼ å…¥å‘½ä»¤æ—¶æ‰åªç”¨ `-i`ã€‚

---

### 5.4.4 docker attach (è°¨æ…ä½¿ç”¨)

æœ¬èŠ‚æ¶µç›–äº†ç›¸å…³å†…å®¹ä¸è¯¦ç»†æè¿°ï¼Œä¸»è¦æ¢è®¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

#### docker attach åŸºæœ¬ç”¨æ³•

è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
$ docker attach å®¹å™¨å
```

#### å·¥ä½œåŸç†

`attach` ä¼šé™„åŠ åˆ°å®¹å™¨çš„ **ä¸»è¿›ç¨‹** (PID 1) çš„æ ‡å‡†è¾“å…¥è¾“å‡ºï¼š

```mermaid
flowchart LR
    subgraph Container ["å®¹å™¨"]
        direction TB
        subgraph Process ["ä¸»è¿›ç¨‹"]
            P1["PID 1: /bin/bash<br>(ä½ çš„è¾“å…¥ç›´æ¥å‘é€åˆ°ä¸»è¿›ç¨‹)"]
        end
    end
    Attach["docker attach"] -->|"é™„åŠ åˆ°è¿™é‡Œ"| P1
```

#### docker attach ç¤ºä¾‹

è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
## å¯åŠ¨å®¹å™¨

$ docker run -dit --name myubuntu ubuntu
243c32535da7...

## é™„åŠ åˆ°å®¹å™¨

$ docker attach myubuntu
root@243c32535da7:/#
```

#### âš ï¸ é‡è¦è­¦å‘Š

**ä» attach ä¼šè¯ä¸­è¾“å…¥ `exit` æˆ–æŒ‰ `Ctrl+D` ä¼šå¯¼è‡´å®¹å™¨åœæ­¢ï¼**

```bash
$ docker attach myubuntu
root@243c32535da7:/# exit    # è¿™ä¼šåœæ­¢å®¹å™¨ï¼

$ docker ps
CONTAINER ID   IMAGE    STATUS                     NAMES
243c32535da7   ubuntu   Exited (0) 2 seconds ago   myubuntu
```

**åŸå› **ï¼šattach é™„åŠ åˆ°ä¸»è¿›ç¨‹ï¼Œé€€å‡ºä¸»è¿›ç¨‹å°±ç­‰äºé€€å‡ºå®¹å™¨ã€‚

#### å®‰å…¨é€€å‡º attach

ä½¿ç”¨ `Ctrl+P` ç„¶å `Ctrl+Q` å¯ä»¥ä» attach ä¼šè¯ä¸­ **åˆ†ç¦»**ï¼Œè€Œä¸åœæ­¢å®¹å™¨ï¼š

```bash
$ docker attach myubuntu
root@243c32535da7:/# 
## æŒ‰ Ctrl+P ç„¶å Ctrl+Q

read escape sequence

$ docker ps    # å®¹å™¨ä»åœ¨è¿è¡Œ
CONTAINER ID   IMAGE    STATUS         NAMES
243c32535da7   ubuntu   Up 5 minutes   myubuntu
```

---

### 5.4.5 exec vs attach å¯¹æ¯”

ç›¸å…³ä¿¡æ¯å¦‚ä¸‹è¡¨ï¼š

| ç‰¹æ€§ | docker exec | docker attach |
|------|-------------|---------------|
| **å·¥ä½œæ–¹å¼** | åœ¨å®¹å™¨å†…å¯åŠ¨æ–°è¿›ç¨‹ | é™„åŠ åˆ°ä¸»è¿›ç¨‹ |
| **é€€å‡ºå½±å“** | ä¸å½±å“å®¹å™¨ | å¯èƒ½åœæ­¢å®¹å™¨ |
| **å¤šç»ˆç«¯** | å¯ä»¥å¼€å¤šä¸ª | å…±äº«åŒä¸€ä¸ªä¼šè¯ |
| **é€‚ç”¨åœºæ™¯** | è°ƒè¯•ã€ä¸´æ—¶æ“ä½œ | æŸ¥çœ‹ä¸»è¿›ç¨‹è¾“å‡º |
| **æ¨èç¨‹åº¦** | âœ… æ¨è | âš ï¸ ç‰¹æ®Šåœºæ™¯ä½¿ç”¨ |

```mermaid
flowchart LR
    subgraph Exec ["docker exec"]
        direction TB
        subgraph Container1 ["å®¹å™¨"]
            E_PID1["PID 1: nginx"]
            E_PID50["PID 50: bash"]
        end
        NewProc["æ–°è¿›ç¨‹"] -- é™„åŠ åˆ° --> E_PID50
    end
    
    subgraph Attach ["docker attach"]
        direction TB
        subgraph Container2 ["å®¹å™¨"]
            A_PID1["PID 1: bash"]
        end
        MainProc["é™„åŠ åˆ°ä¸»è¿›ç¨‹"] --> A_PID1
    end
    
    note1["é€€å‡º bash ä¸å½±å“ nginx"]
    note2["é€€å‡º bash å®¹å™¨åœæ­¢"]
    Container1 -.-> note1
    Container2 -.-> note2
```

---

### 5.4.6 æœ€ä½³å®è·µ

æœ¬èŠ‚æ¶µç›–äº†ç›¸å…³å†…å®¹ä¸è¯¦ç»†æè¿°ï¼Œä¸»è¦æ¢è®¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

#### 1. é¦–é€‰ docker exec

è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
## è¿›å…¥å®¹å™¨è°ƒè¯•

$ docker exec -it myapp bash

## æŸ¥çœ‹æ—¥å¿—

$ docker exec myapp tail -f /var/log/app.log

## æ‰§è¡Œæ•°æ®åº“è¿ç§»

$ docker exec myapp python manage.py migrate
```

#### 2. ç”Ÿäº§ç¯å¢ƒé¿å…è¿›å…¥å®¹å™¨

ç¬”è€…å»ºè®®ï¼šç”Ÿäº§ç¯å¢ƒåº”å°½é‡é¿å…è¿›å…¥å®¹å™¨ç›´æ¥æ“ä½œï¼Œè€Œæ˜¯é€šè¿‡ï¼š

- æ—¥å¿—ç³»ç»ŸæŸ¥çœ‹æ—¥å¿— (å¦‚ `docker logs` æˆ–é›†ä¸­å¼æ—¥å¿—)
- ç›‘æ§ç³»ç»ŸæŸ¥çœ‹çŠ¶æ€
- é‡æ–°éƒ¨ç½²è€Œéæ‰‹åŠ¨ä¿®æ”¹

#### 3. æ—  shell é•œåƒçš„å¤„ç†

æŸäº›ç²¾ç®€é•œåƒ (å¦‚åŸºäº `scratch` æˆ– `distroless`) æ²¡æœ‰ shellï¼š

```bash
## è¿™ä¼šå¤±è´¥

$ docker exec -it myapp bash
OCI runtime exec failed: exec failed: unable to start container process: exec: "bash": executable file not found

## è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨è°ƒè¯•å®¹å™¨ï¼ˆDocker Desktop æˆ– Kubernetes debugï¼‰

$ docker debug myapp
```

---

### 5.4.7 å¸¸è§é—®é¢˜

æœ¬èŠ‚æ¶µç›–äº†ç›¸å…³å†…å®¹ä¸è¯¦ç»†æè¿°ï¼Œä¸»è¦æ¢è®¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

#### Qï¼šexec è¿›å…¥åçœ‹ä¸åˆ°å…¶ä»–ç»ˆç«¯çš„æ“ä½œ

è¿™æ˜¯æ­£å¸¸çš„ã€‚exec å¯åŠ¨çš„æ˜¯ç‹¬ç«‹è¿›ç¨‹ï¼Œå¤šä¸ª exec ä¼šè¯äº’ä¸å½±å“ã€‚

#### Qï¼šå®¹å™¨æ²¡æœ‰ bash

å°è¯•ä½¿ç”¨ shï¼š

```bash
$ docker exec -it myapp /bin/sh
```

#### Qï¼šéœ€è¦ root æƒé™

è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
$ docker exec -u root -it myapp bash
```

---
