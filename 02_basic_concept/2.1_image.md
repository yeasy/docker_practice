## 2.1 Docker é•œåƒ

## Docker é•œåƒ

Docker é•œåƒä½œä¸ºå®¹å™¨è¿è¡Œçš„åŸºçŸ³ï¼Œå…¶è®¾è®¡ç†å¿µå’Œå®ç°æœºåˆ¶è‡³å…³é‡è¦ã€‚æœ¬èŠ‚å°†æ·±å…¥æ¢è®¨é•œåƒçš„æœ¬è´¨ã€ä¸æ“ä½œç³»ç»Ÿçš„å…³ç³»ã€å†…å®¹æ„æˆä»¥åŠæ ¸å¿ƒçš„åˆ†å±‚å­˜å‚¨æœºåˆ¶ã€‚

### ä¸€å¥è¯ç†è§£é•œåƒ

> **Docker é•œåƒæ˜¯ä¸€ä¸ªåªè¯»çš„æ¨¡æ¿ï¼ŒåŒ…å«äº†è¿è¡Œåº”ç”¨æ‰€éœ€çš„ä¸€åˆ‡ï¼šä»£ç ã€è¿è¡Œæ—¶ã€åº“ã€ç¯å¢ƒå˜é‡å’Œé…ç½®æ–‡ä»¶ã€‚**

å¦‚æœç”¨ä¸€ä¸ªç±»æ¯”ï¼š**é•œåƒå°±åƒæ˜¯ä¸€å¼ å…‰ç›˜æˆ– ISO æ–‡ä»¶**ã€‚ä½ å¯ä»¥ç”¨åŒä¸€å¼ å…‰ç›˜åœ¨ä¸åŒç”µè„‘ä¸Šå®‰è£…ç³»ç»Ÿï¼Œè€Œå…‰ç›˜æœ¬èº«ä¸ä¼šè¢«ä¿®æ”¹ã€‚åŒæ ·ï¼Œä¸€ä¸ªé•œåƒå¯ä»¥åˆ›å»ºå¤šä¸ªå®¹å™¨ï¼Œè€Œé•œåƒæœ¬èº«ä¿æŒä¸å˜ã€‚

### é•œåƒä¸æ“ä½œç³»ç»Ÿçš„å…³ç³»

æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œæ“ä½œç³»ç»Ÿåˆ†ä¸º**å†…æ ¸**å’Œ**ç”¨æˆ·ç©ºé—´**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç”¨æˆ·ç©ºé—´                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  åº”ç”¨ç¨‹åºã€å·¥å…·ã€åº“ã€é…ç½®æ–‡ä»¶...                       â”‚   â”‚
â”‚  â”‚  ï¼ˆè¿™éƒ¨åˆ†è¢«æ‰“åŒ…æˆ Docker é•œåƒï¼‰                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      Linux å†…æ ¸                             â”‚
â”‚             ï¼ˆå®¹å™¨å…±äº«å®¿ä¸»æœºçš„å†…æ ¸ï¼‰                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

å¯¹äº Linux è€Œè¨€ï¼Œå†…æ ¸å¯åŠ¨åä¼šæŒ‚è½½ `root` æ–‡ä»¶ç³»ç»Ÿæ¥æä¾›ç”¨æˆ·ç©ºé—´æ”¯æŒã€‚**Docker é•œåƒ**æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ª `root` æ–‡ä»¶ç³»ç»Ÿã€‚

ä¾‹å¦‚ï¼Œå®˜æ–¹é•œåƒ `ubuntu:24.04` åŒ…å«äº†ä¸€å¥—å®Œæ•´çš„ Ubuntu 24.04 æœ€å°ç³»ç»Ÿçš„ root æ–‡ä»¶ç³»ç»Ÿâ€”â€”ä½†**ä¸åŒ…å« Linux å†…æ ¸**ï¼ˆå› ä¸ºå®¹å™¨å…±äº«å®¿ä¸»æœºçš„å†…æ ¸ï¼‰ã€‚

### é•œåƒåŒ…å«ä»€ä¹ˆï¼Ÿ

Docker é•œåƒæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ–‡ä»¶ç³»ç»Ÿï¼ŒåŒ…å«ï¼š

| å†…å®¹ç±»å‹ | ç¤ºä¾‹ |
|---------|------|
| **ç¨‹åºæ–‡ä»¶** | åº”ç”¨äºŒè¿›åˆ¶æ–‡ä»¶ã€Python/Node è§£é‡Šå™¨ |
| **åº“æ–‡ä»¶** | libcã€OpenSSLã€å„ç§ä¾èµ–åº“ |
| **é…ç½®æ–‡ä»¶** | nginx.confã€my.cnf ç­‰ |
| **ç¯å¢ƒå˜é‡** | PATHã€LANG ç­‰é¢„è®¾å€¼ |
| **å…ƒæ•°æ®** | å¯åŠ¨å‘½ä»¤ã€æš´éœ²ç«¯å£ã€æ•°æ®å·å®šä¹‰ |

**å…³é”®ç‰¹æ€§**ï¼š
- âœ… é•œåƒæ˜¯**åªè¯»**çš„
- âœ… é•œåƒ**ä¸åŒ…å«**åŠ¨æ€æ•°æ®
- âœ… é•œåƒæ„å»ºå**å†…å®¹ä¸ä¼šæ”¹å˜**

### åˆ†å±‚å­˜å‚¨ï¼šé•œåƒçš„æ ¸å¿ƒè®¾è®¡

### åˆ†å±‚å­˜å‚¨ï¼šé•œåƒçš„æ ¸å¿ƒè®¾è®¡

é•œåƒçš„åˆ†å±‚å­˜å‚¨æœºåˆ¶æ˜¯ Docker æœ€å…·åˆ›æ–°æ€§çš„ç‰¹æ€§ä¹‹ä¸€ã€‚é€šè¿‡ Union FS æŠ€æœ¯ï¼ŒDocker èƒ½å¤Ÿé«˜æ•ˆåœ°æ„å»ºå’Œç®¡ç†é•œåƒã€‚

#### ä¸ºä»€ä¹ˆéœ€è¦åˆ†å±‚ï¼Ÿ

ç¬”è€…è®¤ä¸ºï¼Œåˆ†å±‚å­˜å‚¨æ˜¯ Docker æœ€å·§å¦™çš„è®¾è®¡ä¹‹ä¸€ã€‚

å‡è®¾ä½ æœ‰ä¸‰ä¸ªåº”ç”¨ï¼Œéƒ½åŸºäº Ubuntu è¿è¡Œï¼š

```
ä¼ ç»Ÿæ–¹å¼ï¼ˆä¸åˆ†å±‚ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   App A     â”‚  â”‚   App B     â”‚  â”‚   App C     â”‚
â”‚   Ubuntu    â”‚  â”‚   Ubuntu    â”‚  â”‚   Ubuntu    â”‚
â”‚   500MB     â”‚  â”‚   500MB     â”‚  â”‚   500MB     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                æ€»è®¡ï¼š1.5GB âŒ

Docker åˆ†å±‚æ–¹å¼ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   App A     â”‚  â”‚   App B     â”‚  â”‚   App C     â”‚
â”‚   50MB      â”‚  â”‚   30MB      â”‚  â”‚   40MB      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                â”‚                â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚     Ubuntu      â”‚
               â”‚  ï¼ˆå…±äº«ï¼‰500MB   â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                æ€»è®¡ï¼š620MB âœ…
```

#### åˆ†å±‚æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ

ç¬”è€…ç”¨ä¸€ä¸ªå®é™…çš„ Dockerfile æ¥è§£é‡Šåˆ†å±‚ï¼š

```docker
FROM ubuntu:24.04          # ç¬¬ 1 å±‚ï¼šåŸºç¡€ç³»ç»Ÿï¼ˆçº¦ 78MBï¼‰
RUN apt-get update         # ç¬¬ 2 å±‚ï¼šæ›´æ–°åŒ…ç´¢å¼•
RUN apt-get install nginx  # ç¬¬ 3 å±‚ï¼šå®‰è£… nginx
COPY app.conf /etc/nginx/  # ç¬¬ 4 å±‚ï¼šå¤åˆ¶é…ç½®æ–‡ä»¶
```

æ„å»ºåçš„é•œåƒç»“æ„ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ 4 å±‚: COPY app.conf (åªè¯»)       â”‚  â† æœ€æ–°æ·»åŠ çš„å±‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç¬¬ 3 å±‚: nginx å®‰è£…æ–‡ä»¶ (åªè¯»)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç¬¬ 2 å±‚: apt ç¼“å­˜æ›´æ–° (åªè¯»)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç¬¬ 1 å±‚: Ubuntu åŸºç¡€ç³»ç»Ÿ (åªè¯»)      â”‚  â† åŸºç¡€é•œåƒå±‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

æ¯ä¸€å±‚çš„ç‰¹ç‚¹ï¼š
- **åªè¯»**ï¼šæ„å»ºå®Œæˆåä¸å¯ä¿®æ”¹
- **å¯å…±äº«**ï¼šå¤šä¸ªé•œåƒå¯ä»¥å…±äº«ç›¸åŒçš„å±‚
- **æœ‰ç¼“å­˜**ï¼šæœªå˜åŒ–çš„å±‚ä¸ä¼šé‡æ–°æ„å»º

#### åˆ†å±‚å­˜å‚¨çš„"é™·é˜±"

> âš ï¸ **ç¬”è€…ç‰¹åˆ«æé†’**ï¼šç†è§£è¿™ä¸€ç‚¹å¯ä»¥å¸®ä½ é¿å…æ„å»ºå‡ºè‡ƒè‚¿çš„é•œåƒã€‚

**å…³é”®åŸç†**ï¼šæ¯ä¸€å±‚çš„æ–‡ä»¶å˜åŒ–ä¼šè¢«è®°å½•ï¼Œä½†**åˆ é™¤æ“ä½œåªæ˜¯æ ‡è®°ï¼Œä¸ä¼šçœŸæ­£å‡å°é•œåƒä½“ç§¯**ã€‚

```docker
## é”™è¯¯ç¤ºèŒƒ âŒ

FROM ubuntu:24.04
RUN apt-get update
RUN apt-get install -y build-essential  # å®‰è£…ç¼–è¯‘å·¥å…·ï¼ˆçº¦ 200MBï¼‰
RUN make && make install                  # ç¼–è¯‘åº”ç”¨
RUN apt-get remove build-essential        # è¯•å›¾åˆ é™¤ç¼–è¯‘å·¥å…·
## ç»“æœï¼šé•œåƒä»ç„¶åŒ…å« 200MB çš„ç¼–è¯‘å·¥å…·ï¼

## ç»“æœï¼šé•œåƒä»ç„¶åŒ…å« 200MB çš„ç¼–è¯‘å·¥å…·ï¼
```

```docker
## æ­£ç¡®åšæ³• âœ…

FROM ubuntu:24.04
RUN apt-get update && \
    apt-get install -y build-essential && \
    make && make install && \
    apt-get remove -y build-essential && \
    apt-get autoremove -y && \
    rm -rf /var/lib/apt/lists/*
## åœ¨åŒä¸€å±‚å®Œæˆå®‰è£…ã€ä½¿ç”¨ã€æ¸…ç†

## åœ¨åŒä¸€å±‚å®Œæˆå®‰è£…ã€ä½¿ç”¨ã€æ¸…ç†
```

#### æŸ¥çœ‹é•œåƒçš„åˆ†å±‚

è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
## æŸ¥çœ‹é•œåƒçš„å†å²ï¼ˆæ¯å±‚çš„æ„å»ºè®°å½•ï¼‰

$ docker history nginx:latest

IMAGE          CREATED       CREATED BY                                      SIZE
a6bd71f48f68   2 weeks ago   CMD ["nginx" "-g" "daemon off;"]                0B
<missing>      2 weeks ago   STOPSIGNAL SIGQUIT                              0B
<missing>      2 weeks ago   EXPOSE map[80/tcp:{}]                           0B
<missing>      2 weeks ago   ENTRYPOINT ["/docker-entrypoint.sh"]            0B
<missing>      2 weeks ago   COPY 30-tune-worker-processes.sh /docker-entâ€¦   4.62kB
...
```

### é•œåƒçš„æ ‡è¯†

Docker é•œåƒæœ‰å¤šç§æ ‡è¯†æ–¹å¼ï¼š

#### 1. é•œåƒåç§°å’Œæ ‡ç­¾

æ ¼å¼ï¼š`[ä»“åº“åœ°å€/]ä»“åº“å[:æ ‡ç­¾]`

```bash
## å®Œæ•´æ ¼å¼

registry.example.com/myproject/myapp:v1.2.3

## ç®€å†™ï¼ˆä½¿ç”¨ Docker Hubï¼‰

nginx:1.25
ubuntu:24.04

## çœç•¥æ ‡ç­¾ï¼ˆé»˜è®¤ä½¿ç”¨ latestï¼‰

nginx  # ç­‰åŒäº nginx:latest
```

#### 2. é•œåƒ IDï¼ˆContent-Addressableï¼‰

æ¯ä¸ªé•œåƒæœ‰ä¸€ä¸ªåŸºäºå†…å®¹è®¡ç®—çš„å”¯ä¸€ IDï¼š

```bash
$ docker images
REPOSITORY   TAG       IMAGE ID       CREATED        SIZE
nginx        latest    a6bd71f48f68   2 weeks ago    187MB
ubuntu       24.04     ca2b0f26964c   3 weeks ago    78.1MB
```

#### 3. é•œåƒæ‘˜è¦ï¼ˆDigestï¼‰

æ›´ç²¾ç¡®çš„æ ‡è¯†ï¼ŒåŸºäºé•œåƒå†…å®¹çš„ SHA256 å“ˆå¸Œï¼š

```bash
$ docker images --digests
REPOSITORY  TAG     DIGEST                                                                    IMAGE ID
nginx       latest  sha256:6db391d1c0cfb30588ba0bf72ea999404f2764184d8b8d10d89e8a9c6... a6bd71f48f68
```

> ğŸ’¡ ç¬”è€…å»ºè®®ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨é•œåƒæ‘˜è¦è€Œéæ ‡ç­¾ï¼Œå› ä¸ºæ ‡ç­¾å¯ä»¥è¢«è¦†ç›–ï¼Œä½†æ‘˜è¦æ˜¯ä¸å¯å˜çš„ã€‚

### é•œåƒçš„æ¥æº

Docker é•œåƒå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è·å–ï¼š

| æ–¹å¼ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| **ä» Registry æ‹‰å–** | æœ€å¸¸ç”¨çš„æ–¹å¼ | `docker pull nginx` |
| **ä» Dockerfile æ„å»º** | è‡ªå®šä¹‰é•œåƒ | `docker build -t myapp .` |
| **ä»å®¹å™¨æäº¤** | ä¿å­˜å®¹å™¨çŠ¶æ€ï¼ˆä¸æ¨èï¼‰ | `docker commit` |
| **ä»æ–‡ä»¶å¯¼å…¥** | ç¦»çº¿ä¼ è¾“ | `docker load < image.tar` |

### æœ¬ç« å°ç»“

| æ¦‚å¿µ | è¦ç‚¹ |
|------|------|
| **é•œåƒæ˜¯ä»€ä¹ˆ** | åªè¯»çš„åº”ç”¨æ¨¡æ¿ï¼ŒåŒ…å«è¿è¡Œæ‰€éœ€çš„ä¸€åˆ‡ |
| **åˆ†å±‚å­˜å‚¨** | å¤šå±‚å åŠ ï¼Œå…±äº«åŸºç¡€å±‚ï¼ŒèŠ‚çœç©ºé—´ |
| **åªè¯»ç‰¹æ€§** | æ„å»ºåä¸å¯ä¿®æ”¹ï¼Œä¿è¯ä¸€è‡´æ€§ |
| **å±‚çš„é™·é˜±** | åˆ é™¤æ“ä½œåªæ˜¯æ ‡è®°ï¼Œä¸å‡å°ä½“ç§¯ |

ç†è§£äº†é•œåƒï¼Œæ¥ä¸‹æ¥è®©æˆ‘ä»¬å­¦ä¹ [å®¹å™¨](2.2_container.md)â€”â€”é•œåƒçš„è¿è¡Œå®ä¾‹ã€‚

### å»¶ä¼¸é˜…è¯»

- [è·å–é•œåƒ](../04_image/4.1_pull.md)ï¼šä» Registry ä¸‹è½½é•œåƒ
- [ä½¿ç”¨ Dockerfile å®šåˆ¶é•œåƒ](../04_image/4.5_build.md)ï¼šåˆ›å»ºè‡ªå·±çš„é•œåƒ
- [Dockerfile æœ€ä½³å®è·µ](../16_appendix/16.1_best_practices.md)ï¼šæ„å»ºé«˜è´¨é‡é•œåƒçš„æŠ€å·§
- [åº•å±‚å®ç° - è”åˆæ–‡ä»¶ç³»ç»Ÿ](../14_implementation/14.4_ufs.md)ï¼šæ·±å…¥ç†è§£åˆ†å±‚å­˜å‚¨çš„æŠ€æœ¯åŸç†
