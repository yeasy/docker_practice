## 2.3 Docker Registry

Docker Registry æ˜¯é•œåƒåˆ†å‘å’Œç®¡ç†çš„æ ¸å¿ƒç»„ä»¶ã€‚æœ¬èŠ‚å°†ä»‹ç» Registry çš„åŸºæœ¬æ¦‚å¿µã€å…¬å…±å’Œç§æœ‰æœåŠ¡çš„é€‰æ‹©ï¼Œä»¥åŠé•œåƒçš„å®‰å…¨ç®¡ç†ã€‚

### 2.3.1 ä¸€å¥è¯ç†è§£ Registry

> **Docker Registry æ˜¯å­˜å‚¨å’Œåˆ†å‘ Docker é•œåƒçš„æœåŠ¡ï¼Œç±»ä¼¼äºä»£ç çš„ GitHub æˆ–åŒ…ç®¡ç†çš„ npmã€‚**

é•œåƒæ„å»ºå®Œæˆåï¼Œå¯ä»¥åœ¨å½“å‰æœºå™¨ä¸Šè¿è¡Œã€‚ä½†å¦‚æœéœ€è¦åœ¨å…¶ä»–æœåŠ¡å™¨ä¸Šä½¿ç”¨è¿™ä¸ªé•œåƒï¼Œå°±éœ€è¦ä¸€ä¸ªé›†ä¸­çš„å­˜å‚¨å’Œåˆ†å‘æœåŠ¡â€”â€”è¿™å°±æ˜¯ Docker Registryã€‚

### 2.3.2 æ ¸å¿ƒæ¦‚å¿µ

è¦ç†Ÿç»ƒä½¿ç”¨ Docker Registryï¼Œé¦–å…ˆéœ€è¦ç†æ¸…å®ƒä¸ä»“åº“ (Repository)ã€æ ‡ç­¾ (Tag) ä¹‹é—´çš„å…³ç³»ã€‚

#### Registryã€ä»“åº“ã€æ ‡ç­¾çš„å…³ç³»

Docker Registry ä¸­å¯ä»¥åŒ…å«å¤šä¸ª Repositoryï¼Œæ¯ä¸ª Repository å¯ä»¥åŒ…å«å¤šä¸ª Tagã€‚å¦‚å›¾ 2-2 æ‰€ç¤ºï¼Œå®ƒä»¬ä¹‹é—´å…·æœ‰æ¸…æ™°çš„å±‚çº§å…³ç³»ã€‚

```mermaid
flowchart TB
    subgraph Registry ["Docker Registryï¼ˆå¦‚ Docker Hubï¼‰"]
        direction TB
        subgraph RepoNginx ["Repositoryï¼ˆä»“åº“ï¼‰: nginx"]
            direction LR
            N1(":latest (tag)")
            N2(":1.25 (tag)")
            N3(":1.24 (tag)")
            N4(":alpine (tag)")
            N5("...")
            N1 ~~~ N2 ~~~ N3 ~~~ N4 ~~~ N5
        end
        subgraph RepoMysql ["Repositoryï¼ˆä»“åº“ï¼‰: mysql"]
            direction LR
            M1(":latest")
            M2(":8.0")
            M3(":5.7")
            M4("...")
            M1 ~~~ M2 ~~~ M3 ~~~ M4
        end
        RepoNginx ~~~ RepoMysql
    end
```

å›¾ 2-2 Registryã€Repository ä¸ Tag çš„å±‚çº§å…³ç³»

ç›¸å…³åŸºæœ¬æ¦‚å¿µå…·ä½“å¦‚ä¸‹ï¼š

| æ¦‚å¿µ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| **Registry** | å­˜å‚¨é•œåƒçš„æœåŠ¡ | Docker Hubã€ghcr.io |
| **Repository (ä»“åº“)** | åŒä¸€è½¯ä»¶çš„é•œåƒé›†åˆ | `nginx`ã€`mysql`ã€`mycompany/myapp` |
| **Tag (æ ‡ç­¾)** | ä»“åº“å†…çš„ç‰ˆæœ¬æ ‡è¯† | `latest`ã€`1.25`ã€`alpine` |

#### é•œåƒçš„å®Œæ•´åç§°

ä¸€ä¸ªå®Œæ•´çš„ Docker é•œåƒåç§°ç”± Registry åœ°å€ã€ç”¨æˆ·å/ç»„ç»‡åã€ä»“åº“åå’Œæ ‡ç­¾ç»„æˆã€‚äº†è§£å…¶ç»“æ„æœ‰åŠ©äºæˆ‘ä»¬æ›´å‡†ç¡®åœ°å®šä½é•œåƒã€‚åŸºæœ¬æ ¼å¼å¦‚ä¸‹ï¼š

```bash
[registryåœ°å€/][ç”¨æˆ·å/]ä»“åº“å[:æ ‡ç­¾]
```

ç¤ºä¾‹ï¼š

```bash
## å®Œæ•´æ ¼å¼

registry.example.com/mycompany/myapp:v1.2.3
â”‚                    â”‚         â”‚     â”‚
â”‚                    â”‚         â”‚     â””â”€â”€ æ ‡ç­¾
â”‚                    â”‚         â””â”€â”€ ä»“åº“å
â”‚                    â””â”€â”€ ç”¨æˆ·å/ç»„ç»‡å
â””â”€â”€ Registry åœ°å€

## Docker Hub å®˜æ–¹é•œåƒï¼ˆçœç•¥ registry å’Œç”¨æˆ·åï¼‰

nginx:1.25
ubuntu:24.04

## Docker Hub ç”¨æˆ·é•œåƒ

jwilder/nginx-proxy:latest

## å…¶ä»– Registry

ghcr.io/username/myapp:v1.0
gcr.io/google-containers/pause:3.6
```

> ğŸ’¡ **ç¬”è€…æç¤º**ï¼šå¦‚æœä¸æŒ‡å®š Registry åœ°å€ï¼Œé»˜è®¤ä½¿ç”¨ Docker Hubã€‚å¦‚æœä¸æŒ‡å®šæ ‡ç­¾ï¼Œé»˜è®¤ä½¿ç”¨ `latest`ã€‚

### 2.3.3 å…¬å…± Registry æœåŠ¡

å…¬å…± Registry æœåŠ¡ä¸ºå¼€å‘è€…æä¾›äº†ä¾¿æ·çš„é•œåƒè·å–é€”å¾„ã€‚å…¶ä¸­æœ€è‘—åçš„æ˜¯ Docker Hubã€‚

#### é»˜è®¤çš„ Docker Hub

[Docker Hub](https://hub.docker.com/) æ˜¯æœ€å¤§çš„å…¬å…± Registryï¼Œä¹Ÿæ˜¯ Docker çš„é»˜è®¤ Registryã€‚

**ç‰¹ç‚¹**ï¼š

- æ‹¥æœ‰å¤§é‡[å®˜æ–¹é•œåƒ](https://hub.docker.com/search?q=&type=image&image_filter=official) (nginxã€mysqlã€redis ç­‰)
- å…è´¹è´¦æˆ·å¯ä»¥åˆ›å»ºå…¬å¼€ä»“åº“
- ä»˜è´¹è´¦æˆ·æ”¯æŒç§æœ‰ä»“åº“

```bash
## ä» Docker Hub æ‹‰å–é•œåƒ

$ docker pull nginx              # å®˜æ–¹é•œåƒ
$ docker pull bitnami/redis      # ç¬¬ä¸‰æ–¹é•œåƒ

## æ¨é€é•œåƒåˆ° Docker Hub

$ docker login
$ docker push username/myapp:v1.0
```

#### å…¶ä»–å…¬å…± Registry

é™¤äº† Docker Hubï¼Œè¿˜æœ‰ä»¥ä¸‹å‡ ä¸ªå¸¸è§çš„å…¬å…± Registryï¼š

| Registry | åœ°å€ | è¯´æ˜ |
|----------|------|------|
| **GitHub Container Registry** | ghcr.io | GitHub æä¾›ï¼Œä¸ GitHub Actions é›†æˆå¥½ |
| **Google Container Registry** | gcr.io | Google Cloud æä¾›ï¼ŒKubernetes é•œåƒå¸¸ç”¨ |
| **Quay.io** | quay.io | Red Hat æä¾› |
| **é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡** | registry.cn-*.aliyuncs.com | å›½å†…è®¿é—®å¿« |
| **è…¾è®¯äº‘å®¹å™¨é•œåƒæœåŠ¡** | ccr.ccs.tencentyun.com | å›½å†…è®¿é—®å¿« |

### 2.3.4 é•œåƒåŠ é€Ÿå™¨

ç”±äºç½‘ç»œåŸå› ï¼Œåœ¨å›½å†…ç›´æ¥è®¿é—® Docker Hub å¯èƒ½ä¼šå¾ˆæ…¢ã€‚å¯ä»¥é…ç½® **é•œåƒåŠ é€Ÿå™¨** (Registry Mirror) æ¥åŠ é€Ÿä¸‹è½½ã€‚é…ç½®ç¤ºä¾‹å¦‚ä¸‹ï¼š

```json
// /etc/docker/daemon.json
{
  "registry-mirrors": [
    "https://your-accelerator-url"
  ]
}
```

è¯¦ç»†é…ç½®æ–¹æ³•è¯·å‚è€ƒ[é•œåƒåŠ é€Ÿå™¨](../03_install/3.9_mirror.md)ç« èŠ‚ã€‚

> âš ï¸ **ç¬”è€…æé†’**ï¼šé•œåƒåŠ é€Ÿå™¨çš„å¯ç”¨æ€§ç»å¸¸å˜åŒ–ï¼Œä½¿ç”¨å‰å»ºè®®å…ˆæµ‹è¯•æ˜¯å¦å¯ç”¨ã€‚

### 2.3.5 ç§æœ‰ Registry

å‡ºäºå®‰å…¨å’Œéšç§çš„è€ƒè™‘ï¼Œä¼ä¸šå¾€å¾€éœ€è¦æ­å»ºè‡ªå·±çš„ç§æœ‰ Registryã€‚ä»¥ä¸‹æ˜¯å‡ ç§å¸¸è§çš„æ­å»ºæ–¹æ¡ˆã€‚

#### å®˜æ–¹ Registry é•œåƒ

Docker å®˜æ–¹æä¾›äº† [registry](https://hub.docker.com/_/registry/) é•œåƒï¼Œå¯ä»¥å¿«é€Ÿæ­å»ºç§æœ‰ Registryï¼š

```bash
## å¯åŠ¨ä¸€ä¸ªæœ¬åœ° Registry

$ docker run -d -p 5000:5000 --name registry registry:2

## æ¨é€é•œåƒåˆ°æœ¬åœ° Registry

$ docker tag myapp:v1.0 localhost:5000/myapp:v1.0
$ docker push localhost:5000/myapp:v1.0

## ä»æœ¬åœ° Registry æ‹‰å–

$ docker pull localhost:5000/myapp:v1.0
```

#### ä¼ä¸šçº§è§£å†³æ–¹æ¡ˆ

å®˜æ–¹ Registry åŠŸèƒ½è¾ƒä¸ºåŸºç¡€ï¼Œä¼ä¸šç¯å¢ƒå¸¸ç”¨ä»¥ä¸‹æ–¹æ¡ˆï¼š

| æ–¹æ¡ˆ | ç‰¹ç‚¹ |
|------|------|
| **[Harbor](https://goharbor.io/)** | CNCF é¡¹ç›®ï¼ŒåŠŸèƒ½å…¨é¢ (ç”¨æˆ·ç®¡ç†ã€æ¼æ´æ‰«æã€é•œåƒç­¾å)|
| **[Nexus Repository](../06_repository/6.4_nexus3_registry.md)** | æ”¯æŒå¤šç§åˆ¶å“ç±»å‹ (Dockerã€Mavenã€npm ç­‰)|
| **äº‘å‚å•†æœåŠ¡** | é˜¿é‡Œäº‘ ACRã€è…¾è®¯äº‘ TCRã€AWS ECR ç­‰ |

ç¬”è€…å»ºè®®ï¼š

- å°å›¢é˜Ÿï¼šå¯ä»¥å…ˆç”¨å®˜æ–¹ Registryï¼Œå¤Ÿç”¨å³å¯
- ä¸­å¤§å‹å›¢é˜Ÿï¼šæ¨è Harborï¼ŒåŠŸèƒ½å®Œå–„ä¸”å¼€æºå…è´¹
- å·²ä½¿ç”¨äº‘æœåŠ¡ï¼šç›´æ¥ç”¨äº‘å‚å•†çš„ Registry æœåŠ¡æ›´çœå¿ƒ

### 2.3.6 é•œåƒçš„æ¨é€å’Œæ‹‰å–

æŒæ¡é•œåƒçš„æ¨é€ (Push) å’Œæ‹‰å– (Pull) æ˜¯ä½¿ç”¨ Docker Registry çš„åŸºæœ¬åŠŸã€‚

#### å®Œæ•´å·¥ä½œæµç¨‹

å¦‚å›¾ 2-3 æ‰€ç¤ºï¼Œé•œåƒä»å¼€å‘ç¯å¢ƒæ„å»ºåæ¨é€åˆ° Registryï¼Œå†ç”±ç”Ÿäº§ç¯å¢ƒæ‹‰å–å¹¶è¿è¡Œã€‚

```bash
å¼€å‘è€…æœºå™¨                    Registry                    ç”Ÿäº§æœåŠ¡å™¨
     â”‚                           â”‚                             â”‚
     â”‚  docker build             â”‚                             â”‚
     â”‚  æ„å»ºé•œåƒ                  â”‚                             â”‚
     â”‚                           â”‚                             â”‚
     â”‚  docker push â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶                             â”‚
     â”‚  æ¨é€é•œåƒ                  â”‚  å­˜å‚¨é•œåƒ                   â”‚
     â”‚                           â”‚                             â”‚
     â”‚                           â”‚  â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ docker pull â”‚
     â”‚                           â”‚                  æ‹‰å–é•œåƒ    â”‚
     â”‚                           â”‚                             â”‚
     â”‚                           â”‚                  docker run â”‚
     â”‚                           â”‚                  è¿è¡Œå®¹å™¨    â”‚
```

å›¾ 2-3 é•œåƒæ„å»ºã€æ¨é€ä¸æ‹‰å–æµç¨‹

#### å¸¸ç”¨å‘½ä»¤

```bash
## ç™»å½• Registry

$ docker login                      # ç™»å½• Docker Hub
$ docker login registry.example.com # ç™»å½•å…¶ä»– Registry

## æ‹‰å–é•œåƒ

$ docker pull nginx:1.25

## æ ‡è®°é•œåƒï¼ˆå‡†å¤‡æ¨é€ï¼‰

$ docker tag myapp:latest registry.example.com/myteam/myapp:v1.0

## æ¨é€é•œåƒ

$ docker push registry.example.com/myteam/myapp:v1.0

## ç™»å‡º

$ docker logout
```

### 2.3.7 é•œåƒçš„å®‰å…¨æ€§

åœ¨ä½¿ç”¨å…¬å…±é•œåƒæˆ–ç»´æŠ¤ç§æœ‰é•œåƒæ—¶ï¼Œå®‰å…¨æ€§æ˜¯ä¸å®¹å¿½è§†çš„é‡è¦ç¯èŠ‚ã€‚

#### ä½¿ç”¨å®˜æ–¹é•œåƒ

Docker Hub çš„[å®˜æ–¹é•œåƒ](https://hub.docker.com/search?q=&type=image&image_filter=official) (æ ‡æœ‰ â€œOfficial Imageâ€ æ ‡è¯†) ç»è¿‡ Docker å›¢é˜Ÿå®¡æ ¸ï¼Œç›¸å¯¹æ›´å®‰å…¨ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š

```bash
## å®˜æ–¹é•œåƒç¤ºä¾‹

nginx          # âœ… å®˜æ–¹
mysql          # âœ… å®˜æ–¹
redis          # âœ… å®˜æ–¹

## ç¬¬ä¸‰æ–¹é•œåƒï¼ˆéœ€è¦è‡ªè¡Œè¯„ä¼°å¯ä¿¡åº¦ï¼‰

bitnami/redis  # âš ï¸ éœ€è¦è¯„ä¼°
someuser/myapp # âš ï¸ éœ€è¦è¯„ä¼°
```

#### é•œåƒç­¾å

å½“å‰æ›´æ¨èä½¿ç”¨ Sigstore / Notation ä½“ç³»è¿›è¡Œé•œåƒç­¾åä¸éªŒè¯ã€‚`Docker Content Trust (DCT)` å·²è¿›å…¥é€€åœºé˜¶æ®µï¼Œä¸å»ºè®®ä½œä¸ºæ–°é¡¹ç›®ä¸»æ–¹æ¡ˆã€‚

> æ³¨æ„ï¼šCosign é»˜è®¤ä¼šæŠŠç­¾åå†™å›é•œåƒæ‰€åœ¨ä»“åº“ï¼Œè¯·ä½¿ç”¨ä½ æœ‰æ¨é€æƒé™çš„é•œåƒåœ°å€ã€‚

```bash
## å‡†å¤‡ä¸€ä¸ªä½ æœ‰å†™æƒé™çš„é•œåƒåœ°å€
$ export IMAGE=<ä½ çš„ä»“åº“å>/nginx:1.27
$ docker pull nginx:1.27
$ docker tag nginx:1.27 $IMAGE
$ docker push $IMAGE

## ç”Ÿæˆç­¾åå¯†é’¥ï¼ˆä¼šç”Ÿæˆ cosign.key / cosign.pubï¼‰
$ cosign generate-key-pair

## ä½¿ç”¨ Cosign ç­¾åä¸éªŒè¯
$ cosign sign --key cosign.key $IMAGE
$ cosign verify --key cosign.pub $IMAGE
```

#### æ¼æ´æ‰«æ

```bash
## ä½¿ç”¨ Docker Scout æ‰«æé•œåƒæ¼æ´

$ docker scout cves nginx:latest

## ä½¿ç”¨ Trivyï¼ˆå¼€æºå·¥å…·ï¼‰

$ trivy image nginx:latest
```
